<script>
  const rose = document.getElementById('roseModel');
  const fallbackImage = document.getElementById('fallbackImage');
  const messageEl = document.getElementById('message');

  /* ===== ðŸŽµ MUSIC ===== */
  const music = document.getElementById('bgMusic');
  const musicBtn = document.getElementById('musicBtn');

  let isPlaying = false;
  let musicStarted = false;

  function playMusic() {
    if (!music) return;
    music.play();
    isPlaying = true;
    if (musicBtn) musicBtn.textContent = 'â¸ï¸';
  }

  function toggleMusic() {
    if (!music) return;

    if (!isPlaying) {
      playMusic();
    } else {
      music.pause();
      isPlaying = false;
      if (musicBtn) musicBtn.textContent = 'ðŸŽµ';
    }
  }

  if (musicBtn) {
    musicBtn.addEventListener('click', toggleMusic);
  }

  /* ===== ðŸ’¬ MESSAGES ===== */
  const messages = [
    "...",
    "just like the rose every side of u feels special",
    "I love with everything I have sweetheart",
    "ur forever my beloved",
    "So I made this rose for u"
  ];

  let lastIndex = -1;
  const DEAD_ZONE = 5;

  function radToDeg(rad) {
    return rad * (180 / Math.PI);
  }

  /* ===== ðŸŒ¹ ROTATION + MUSIC START ===== */
  if (rose) {
    rose.addEventListener('camera-change', () => {
      const orbit = rose.getCameraOrbit();
      if (!orbit) return;

      // ðŸŽµ start music on first rotation
      if (!musicStarted) {
        playMusic();
        musicStarted = true;
      }

      let angle = radToDeg(orbit.theta);
      angle = (angle + 360) % 360;

      if (angle < DEAD_ZONE) {
        messageEl.classList.remove('show');
        lastIndex = -1;
        return;
      }

      const section = Math.floor((angle - DEAD_ZONE) / 90);
      const index = ((section % messages.length) + messages.length) % messages.length;

      if (index !== lastIndex) {
        lastIndex = index;
        messageEl.textContent = messages[index];
        messageEl.classList.remove('show');
        requestAnimationFrame(() => messageEl.classList.add('show'));
      }
    });
  }

  /* ===== âŒ GLB RETRY + FALLBACK ===== */
  let hasRetried = false;
  const originalSrc = rose ? rose.getAttribute('src') : null;

  if (rose) {
    rose.addEventListener('error', () => {
      if (!hasRetried) {
        hasRetried = true;
        rose.setAttribute('src', '');
        setTimeout(() => rose.setAttribute('src', originalSrc), 100);
        return;
      }

      rose.style.display = 'none';
      if (fallbackImage) fallbackImage.style.display = 'block';

      messageEl.textContent = messages[0];
      messageEl.classList.add('show');
    });
  }
</script>
