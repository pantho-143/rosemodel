<script>
  const rose = document.getElementById('roseModel');
  const fallbackImage = document.getElementById('fallbackImage');
  const messageEl = document.getElementById('message');

  /* ===== üéµ MUSIC ===== */
  const music = document.getElementById('bgMusic');
  const musicBtn = document.getElementById('musicBtn');
  let isPlaying = false;
  let musicStarted = false;

  function toggleMusic() {
    if (!isPlaying) {
      music.play();
      musicBtn.textContent = '‚è∏Ô∏è';
    } else {
      music.pause();
      musicBtn.textContent = 'üéµ';
    }
    isPlaying = !isPlaying;
  }

  musicBtn.addEventListener('click', toggleMusic);

  /* ===== üí¨ MESSAGES ===== */
  const messages = [
    "...",
    "just like the rose every side of u feels special",
    "I love with everything I have sweetheart",
    "ur forever my beloved",
    "So I made this rose for u"
  ];

  let lastIndex = -1;
  const DEAD_ZONE = 5;

  function radToDeg(rad) {
    return rad * (180 / Math.PI);
  }

  /* ===== üåπ ROTATION + MUSIC START ===== */
  rose.addEventListener('camera-change', () => {
    const orbit = rose.getCameraOrbit();
    if (!orbit) return;

    // üéµ Start music on FIRST rotation only
    if (!musicStarted) {
      music.play();
      musicBtn.textContent = '‚è∏Ô∏è';
      isPlaying = true;
      musicStarted = true;
    }

    let angle = radToDeg(orbit.theta);
    angle = (angle + 360) % 360;

    if (angle < DEAD_ZONE) {
      messageEl.classList.remove('show');
      lastIndex = -1;
      return;
    }

    const section = Math.floor((angle - DEAD_ZONE) / 90);
    const index = ((section % messages.length) + messages.length) % messages.length;

    if (index !== lastIndex) {
      lastIndex = index;
      messageEl.textContent = messages[index];
      messageEl.classList.remove('show');
      requestAnimationFrame(() => messageEl.classList.add('show'));
    }
  });

  /* ===== ‚ùå GLB RETRY + FALLBACK ===== */
  let hasRetried = false;
  const originalSrc = rose.getAttribute('src');

  rose.addEventListener('error', () => {
    if (!hasRetried) {
      hasRetried = true;
      rose.setAttribute('src', '');
      setTimeout(() => {
        rose.setAttribute('src', originalSrc);
      }, 100);
      return;
    }

    // Final fallback
    rose.style.display = 'none';
    fallbackImage.style.display = 'block';

    messageEl.textContent = messages[0];
    messageEl.classList.add('show');
  });
</script>
